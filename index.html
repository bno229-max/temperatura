<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Mapa de Calor</title>
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; background: #eee; }
        .ui { position: absolute; top: 10px; z-index: 100; width: 100%; text-align: center; }
        input { padding: 10px; width: 60%; border-radius: 5px; border: 1px solid #ccc; }
        button { padding: 10px; background: #007bff; color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>

    <div class="ui">
        <input type="text" id="addressInput" placeholder="Digite um lugar...">
        <button onclick="handleSearch()">BUSCAR</button>
    </div>

    <div id="map">Carregando mapa...</div>

    <script>
        const GOOGLE_KEY = "AIzaSyAyeljGisp0yk242H4s3VC_xFeBwESDrjU";
        const WEATHER_KEY = "14211cd3bc55f9316167faf5cee6cc07";

        function gm_authFailure() { 
            alert("Erro de Autenticação no Google Maps. Verifique se a chave está ativa e se as APIs de Maps, Places e Visualization estão ligadas no Console do Google.");
        }
    </script>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAyeljGisp0yk242H4s3VC_xFeBwESDrjU&libraries=places,visualization&callback=initMap" async defer></script>

    <script>
        let map, currentMarker, heatmap;

        function initMap() {
            console.log("Google Maps iniciado");
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 12,
                center: { lat: -23.55, lng: -46.63 }
            });

            // Tenta Geolocalização
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => processLocation(new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude)),
                    () => console.log("Geolocalização negada")
                );
            }
        }

        async function processLocation(location) {
            try {
                // Busca clima real
                const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${location.lat()}&lon=${location.lng()}&units=metric&appid=${WEATHER_KEY}`);
                const data = await res.json();
                
                if(data.cod !== 200) throw new Error(data.message);
                
                const temp = Math.round(data.main.temp);
                document.getElementById('addressInput').value = ""; // Limpa busca

                // Limpa mapas anteriores
                if (currentMarker) currentMarker.setMap(null);
                if (heatmap) heatmap.setMap(null);

                map.setCenter(location);

                // Criar Marcador Termômetro Simples
                currentMarker = new google.maps.Marker({
                    position: location,
                    map: map,
                    label: { text: `${temp}°C`, color: "white", fontWeight: "bold" },
                    title: `Temperatura: ${temp}°C`
                });

                // Simular calor no entorno
                const heatPoints = [];
                for(let i=0; i<30; i++) {
                    heatPoints.push({
                        location: new google.maps.LatLng(location.lat() + (Math.random()-0.5)*0.02, location.lng() + (Math.random()-0.5)*0.02),
                        weight: temp > 25 ? 5 : 1
                    });
                }
                heatmap = new google.maps.visualization.HeatmapLayer({ data: heatPoints, map: map, radius: 50 });

            } catch (err) {
                alert("Erro ao buscar clima: " + err.message);
            }
        }

        function handleSearch() {
            const addr = document.getElementById('addressInput').value;
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address: addr }, (results, status) => {
                if (status === "OK") {
                    processLocation(results[0].geometry.location);
                } else {
                    alert("Local não encontrado: " + status);
                }
            });
        }
    </script>
</body>
</html>